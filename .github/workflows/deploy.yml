name: Deploy to Production

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Deploy to Docker
        run: |
          # Aturar el script si qualsevol comanda falla
          set -e

          # Anar al directori del projecte
          cd /opt/vcpe_api

          echo "ğŸ“¥ 1. Baixant Ãºltims canvis del codi..."
          git pull origin main

          echo "ğŸ³ 2. Reconstruint i reiniciant contenidors..."
          # --build: Assegura que si hem canviat requirements.txt o Dockerfile es regeneri la imatge
          # -d: Executa en segon pla (detached)
          docker compose up -d --build

          echo "ğŸ§¹ 3. Netejant imatges antigues..."
          docker image prune -f

          echo "ğŸ› ï¸ 4. Executant tasques de manteniment Django..."
          # Arreglar permisos del volum static (necessari perquÃ¨ el contenidor corre com usuari 1001)
          docker run --rm -v vcpe_api_static_volume:/data alpine chown -R 1001:1001 /data

          # Recollir fitxers estÃ tics (perquÃ¨ Nginx els pugui servir)
          docker compose exec -T api python manage.py collectstatic --noinput
          # Aplicar migracions de base de dades pendents
          docker compose exec -T api python manage.py migrate --noinput

          echo "âœ… Desplegament completat amb Ã¨xit!"
